{"version":3,"sources":["webpack:///./node_modules/core-js/modules/es.array.reduce.js","webpack:///./src/views/GuitarTuner_2.vue?3dc9","webpack:///./src/views/GuitarTuner_2.vue?4dfd","webpack:///src/views/GuitarTuner_2.vue","webpack:///./src/views/GuitarTuner_2.vue?ad8a","webpack:///./src/views/GuitarTuner_2.vue","webpack:///./node_modules/core-js/modules/es.typed-array.float32-array.js"],"names":["$","$reduce","left","arrayMethodIsStrict","arrayMethodUsesToLength","STRICT_METHOD","USES_TO_LENGTH","1","target","proto","forced","reduce","callbackfn","this","arguments","length","undefined","render","_vm","_h","$createElement","_c","_self","attrs","_v","on","clickHandler","staticClass","_s","getFrequencyStr","getNoteStr","getCentsOffStr","_l","n","key","style","timeArray","staticRenderFns","name","data","gainNode","gain","value","analyser","fftSize","connect","isPlaying","isMute","source","audioCtx","micStream","Float32Array","semiTone","centsOff","computed","getInputFrequency","correlation","Math","abs","correlations","offset","foundGoodCorrelation","best_correlation","best_offset","round","sampleRate","last_correlation","noteStr","methods","stop","play","destination","requestAnimationFrame","getMicData","disconnect","getUserMic","stream","createMediaStreamSource","getFloatTimeDomainData","getSemitone","getCentsOffFromPitch","log","f","getFrequencyFromSemitone","floor","note","mounted","navigator","mediaDevices","getUserMedia","beforeDestroy","component","createTypedArrayConstructor","init","byteOffset"],"mappings":"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","file":"js/chunk-d1d1f5de.a7ea91f5.js","sourcesContent":["'use strict';\nvar $ = require('../internals/export');\nvar $reduce = require('../internals/array-reduce').left;\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar arrayMethodUsesToLength = require('../internals/array-method-uses-to-length');\n\nvar STRICT_METHOD = arrayMethodIsStrict('reduce');\nvar USES_TO_LENGTH = arrayMethodUsesToLength('reduce', { 1: 0 });\n\n// `Array.prototype.reduce` method\n// https://tc39.github.io/ecma262/#sec-array.prototype.reduce\n$({ target: 'Array', proto: true, forced: !STRICT_METHOD || !USES_TO_LENGTH }, {\n  reduce: function reduce(callbackfn /* , initialValue */) {\n    return $reduce(this, callbackfn, arguments.length, arguments.length > 1 ? arguments[1] : undefined);\n  }\n});\n","import mod from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./GuitarTuner_2.vue?vue&type=style&index=0&id=45cc990b&lang=scss&scoped=true&\"; export default mod; export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./GuitarTuner_2.vue?vue&type=style&index=0&id=45cc990b&lang=scss&scoped=true&\"","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{attrs:{\"id\":\"guitar-tuner\"}},[_c('h1',[_vm._v(\"Guitar Tuner 2.0\")]),_c('button',{on:{\"click\":_vm.clickHandler}},[_vm._v(\" On / Off \")]),_c('div',{attrs:{\"id\":\"config\"}},[_c('div',{staticClass:\"audio-note\"},[_c('h3',[_vm._v(_vm._s(_vm.getFrequencyStr))]),_c('h2',[_vm._v(_vm._s(_vm.getNoteStr))]),_c('h4',[_vm._v(_vm._s(_vm.getCentsOffStr))]),_c('div',{staticClass:\"result\"},_vm._l((512),function(n){return _c('div',{key:n,staticClass:\"fftData\",style:({'height': _vm.timeArray[(n-1)]*200+2 + 'px'})})}),0)])])])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\n  <div id=\"guitar-tuner\">\n    <h1>Guitar Tuner 2.0</h1>\n    <button @click=\"clickHandler\"> On / Off </button>\n    <div id=\"config\">\n      <div class=\"audio-note\">\n        <h3>{{getFrequencyStr}}</h3>\n        <h2>{{getNoteStr}}</h2>\n        <h4>{{getCentsOffStr}}</h4>\n        <div class=\"result\">\n          <div class=\"fftData\" v-for=\"n in 512\" :key=\"n\" :style=\"{'height': timeArray[(n-1)]*200+2 + 'px'}\" />\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport audioUnlock from '../lib/audioUnlock'\nexport default {\n  name: \"GuitarTuner2\",\n  data() {\n    const AudioContext = window.AudioContext || window.webkitAudioContext // 跨瀏覽器\n    const audioCtx = new AudioContext() // 主控台的概念\n    const gainNode = audioCtx.createGain() // 增益節點 控制音量的\n    const analyser = audioCtx.createAnalyser()\n\n    gainNode.gain.value = 0\n    analyser.fftSize = 2048\n    analyser.connect(gainNode)\n    return{\n      isPlaying: false,\n      isMute: false,\n      source: null,\n      audioCtx,\n      gainNode,\n      analyser,\n      micStream: null,\n      timeArray: new Float32Array(analyser.fftSize / 2),\n\n      semiTone: null,\n      centsOff: 0,\n    }\n  },\n  computed: {\n    getInputFrequency() {\n      const MAX_SAMPLES = this.timeArray.length / 2 // 由於需要重複測試才能判斷正確波長，故只能做到資料長度的一半\n      const GOOD_ENOUGH_CORRELATION = 0.9 // 相關係數要大於多少才接受\n      const correlations = new Array(MAX_SAMPLES)\n      let best_offset = -1\n      let best_correlation = 0\n      let last_correlation = 1\n      let foundGoodCorrelation  = false // 旗標 紀錄找到好的結果沒\n\n      if(this.timeArray.reduce((rms, d) => rms += d ** 2, 0) < 0.01) return -1\n\n      for(let offset = 0; offset < MAX_SAMPLES; offset++) {\n        let correlation = 0\n        for(let n = 0; n < MAX_SAMPLES; n++) {\n          correlation += Math.abs((this.timeArray[n])-(this.timeArray[n + offset]))\n        }\n        correlation = 1 - (correlation / MAX_SAMPLES) // 相關係數\n        correlations[offset] = correlation\n\n        if ((correlation > GOOD_ENOUGH_CORRELATION) && (correlation > last_correlation)) {\n          // 當找到足夠好的結果的時候\n          foundGoodCorrelation = true\n          if (correlation > best_correlation) {\n            best_correlation = correlation\n            best_offset = offset\n          }\n        } else if (foundGoodCorrelation) {\n          // 前一組為足夠好的結果，且當前的不夠好時\n          const shift = (correlations[best_offset + 1] - correlations[best_offset - 1]) / correlations[best_offset];  \n          return Math.round(this.audioCtx.sampleRate / (best_offset + (8 * shift)))\n        }\n        // 不好的結果\n        last_correlation = correlation\n      }\n      if (best_correlation > 0.01) {\n        return Math.round(this.audioCtx.sampleRate / best_offset)\n      }\n      return -1;\n    },\n    getFrequencyStr() {\n      return this.getInputFrequency > 0 ? this.getInputFrequency : '-'\n    },\n    getNoteStr() {\n      const noteStr = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']\n      return this.semiTone ? noteStr[this.semiTone % 12] : '-'\n    },\n    getCentsOffStr() {\n      return this.centsOff < 0\n      ? Math.abs(this.centsOff) + ' b'\n      : this.centsOff > 0 \n        ? Math.abs(this.centsOff) + ' #'\n        : '-'\n    }\n  },\n  methods: {\n    clickHandler(){\n      if (this.isPlaying) {\n        this.stop()\n      } else {\n        this.play()\n      }\n    },\n    play() {\n      this.isPlaying = true\n      this.gainNode.connect(this.audioCtx.destination)\n      requestAnimationFrame(this.getMicData)\n    },\n    stop() {\n      this.isPlaying = false\n      this.gainNode.disconnect(this.audioCtx.destination)\n    },\n    getUserMic(stream) {\n      this.micStream = stream\n      this.source = this.audioCtx.createMediaStreamSource(stream)\n      this.source.connect(this.analyser)\n    },\n    getMicData(){\n      this.timeArray = new Float32Array(this.analyser.fftSize)\n      this.analyser.getFloatTimeDomainData(this.timeArray)\n      this.semiTone = this.getSemitone(this.getInputFrequency)\n      this.centsOff = this.getCentsOffFromPitch(this.getInputFrequency, this.semiTone)\n      if (this.isPlaying) requestAnimationFrame(this.getMicData)\n    },\n    getSemitone(f) {\n      return Math.round(12 * (Math.log(f / 440) / Math.log(2) )) + 69\n    },\n    getFrequencyFromSemitone(note) {\n\t    return 440 * Math.pow(2, (note - 69) / 12)\n    },\n    getCentsOffFromPitch(f, note) {\n      return Math.floor(1200 * Math.log(f / this.getFrequencyFromSemitone(note)) / Math.log(2))\n    }\n  },\n  mounted() {\n    audioUnlock(this.audioCtx)\n    navigator.mediaDevices.getUserMedia({ audio: true, video: false })\n    .then(this.getUserMic)\n    .catch(e => console.log(e))\n  },\n  beforeDestroy() {\n    if(this.micStream) this.micStream.getAudioTracks()[0].stop()\n  }\n}\n</script>\n<style lang=\"scss\" scoped>\n#guitar-tuner {\n  > button {\n    margin: 10px;\n  }\n  #config {\n    display: flex;\n    justify-content: space-around;\n    flex-direction: column;\n    > .audio-note {\n      width: 50vw;\n      min-width: 300px;\n      margin: 15px auto;\n      border: solid 1px #d9d9d9;\n      .result {\n        display: flex;\n        justify-content: center;\n        height: 300px;\n        vertical-align: middle;\n        align-items: center;\n        overflow: hidden;\n        .fftData {\n          display: block;\n          width: 2px;\n          background-color: #bf8f36;\n        }\n      }\n    }\n  }\n}\n</style>\n","import mod from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./GuitarTuner_2.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./GuitarTuner_2.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./GuitarTuner_2.vue?vue&type=template&id=45cc990b&scoped=true&\"\nimport script from \"./GuitarTuner_2.vue?vue&type=script&lang=js&\"\nexport * from \"./GuitarTuner_2.vue?vue&type=script&lang=js&\"\nimport style0 from \"./GuitarTuner_2.vue?vue&type=style&index=0&id=45cc990b&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"45cc990b\",\n  null\n  \n)\n\nexport default component.exports","var createTypedArrayConstructor = require('../internals/typed-array-constructor');\n\n// `Float32Array` constructor\n// https://tc39.github.io/ecma262/#sec-typedarray-objects\ncreateTypedArrayConstructor('Float32', function (init) {\n  return function Float32Array(data, byteOffset, length) {\n    return init(this, data, byteOffset, length);\n  };\n});\n"],"sourceRoot":""}